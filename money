<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>éŒ¢éƒ½å»å“ªäº†ï¼Ÿ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');

        :root {
            --bg-color: #f2f0e4; /* æš–ç±³è‰² */
            --card-bg: #ffffff;
            --text-color: #2c3e50;
            --accent-color: #e67e22;
            --btn-color: #fdfdfd;
            --btn-border: #dcdcdc;
            --bar-bg: #e0e0e0;
            --danger-color: #e74c3c;
            --success-color: #27ae60;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            font-family: 'Noto Sans TC', sans-serif;
            touch-action: none; /* ç¦æ­¢æ»¾å‹• */
            height: 100vh;
            width: 100vw;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #gameContainer {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 600px; /* æ‰‹æ©Ÿç‰ˆå‹é™åˆ¶ */
            background: var(--bg-color);
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Canvas Layer for Effects and Stats Background */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            width: 100%;
            height: 100%;
        }

        /* UI Layer */
        #uiLayer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ°æŒ‰éˆ• */
            display: flex;
            flex-direction: column;
            padding: 15px; 
        }

        /* Top Info Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            pointer-events: auto;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .day-badge {
            background: #333;
            color: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1rem;
        }

        .money-display {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 5px;
            background: #fff;
            padding: 5px 12px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .help-btn {
            background: #fff;
            border: 1px solid #ccc;
            width: 30px; height: 30px;
            border-radius: 50%;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            margin-left: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Stats Container */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px 12px;
            background: rgba(255,255,255,0.9);
            padding: 8px;
            border-radius: 12px;
            margin-bottom: 10px;
            pointer-events: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .stat-row {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
        }

        .stat-label {
            width: 25px;
            font-size: 1.1rem;
            text-align: center;
        }

        .progress-bar {
            flex-grow: 1;
            height: 8px;
            background: var(--bar-bg);
            border-radius: 4px;
            overflow: hidden;
            margin-left: 4px;
        }

        .progress-fill {
            height: 100%;
            width: 50%;
            transition: width 0.5s ease;
        }

        .stat-val-text {
            font-size: 0.7rem;
            color: #666;
            width: 22px;
            text-align: right;
            margin-left: 4px;
        }

        /* Main Content Area - ä¿®æ­£ 1: å……æ»¿ç•«é¢ */
        #mainContent {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* æ‹‰é–‹é–“è· */
            position: relative;
            pointer-events: none;
            margin-bottom: 10px;
        }

        /* Event Card - ä¿®æ­£ 1: æ‹‰é«˜å¡ç‰‡ */
        .event-card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.08);
            text-align: center;
            pointer-events: auto;
            transition: transform 0.3s, opacity 0.3s;
            border: 1px solid rgba(0,0,0,0.05);
            
            /* New Layout props */
            flex-grow: 1; /* ä½”æ“šå‰©é¤˜ç©ºé–“ */
            display: flex;
            flex-direction: column;
            justify-content: center;
            margin-bottom: 15px;
        }

        .event-emoji {
            font-size: 5rem; /* æ›´å¤§çš„ Emoji */
            display: block;
            margin-bottom: 20px;
        }

        .event-text {
            font-size: 1.4rem;
            font-weight: bold;
            line-height: 1.4;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .event-subtext {
             font-size: 0.85rem;
             color: #95a5a6;
        }

        /* Options */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 15px; /* å¢åŠ é–“è· */
            pointer-events: auto;
            flex-shrink: 0;
        }

        .option-btn {
            background: var(--btn-color);
            border: 2px solid var(--btn-border);
            padding: 18px 20px; /* å¢åŠ æŒ‰éˆ•é«˜åº¦ */
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.1s;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .option-btn:active {
            transform: scale(0.98);
            background: #f0f0f0;
        }

        .option-gain {
            font-size: 0.9rem;
            color: var(--success-color);
            background: rgba(39, 174, 96, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
        }

        /* History Log */
        .history-container {
            margin-top: 10px;
            height: 200px; 
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
            padding: 8px;
            overflow-y: auto;
            font-size: 0.8rem;
            color: #555;
            pointer-events: auto;
            border: 1px solid rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .history-item {
            margin-bottom: 4px;
            border-bottom: 1px dashed #ddd;
            padding-bottom: 2px;
        }

        .history-item span {
            font-weight: bold;
            color: #333;
        }
        
        .diff-pos { color: var(--success-color); }
        .diff-neg { color: var(--danger-color); }

        /* Screens */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(242, 240, 228, 0.98);
            z-index: 100;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            padding: 30px; text-align: center;
            opacity: 0; pointer-events: none;
            transition: opacity 0.5s;
        }

        .screen.active { opacity: 1; pointer-events: auto; }

        .title-main { font-size: 2.2rem; font-weight: 900; color: #2c3e50; margin-bottom: 10px; }
        .subtitle { font-size: 1rem; color: #7f8c8d; margin-bottom: 30px; line-height: 1.5; }
        
        .big-btn {
            background: #2c3e50; color: white; border: none;
            padding: 12px 40px; font-size: 1.1rem;
            border-radius: 50px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(44, 62, 80, 0.3);
            margin: 8px 0; font-weight: bold;
        }
        .secondary-btn {
            background: transparent; border: 2px solid #2c3e50; color: #2c3e50;
            padding: 8px 25px; font-size: 0.9rem; border-radius: 50px;
            cursor: pointer; margin: 5px 0; font-weight: bold;
        }

        /* End Screen Stats */
        .end-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            width: 100%; max-width: 350px;
            margin: 20px 0;
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        .end-stat-item {
            display: flex; justify-content: space-between;
            font-size: 0.9rem; color: #333;
            border-bottom: 1px solid #eee;
            padding: 5px 0;
        }

        /* Legend Modal */
        #legendModal {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white; padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 200; width: 80%; max-width: 300px;
            display: none;
        }
        #legendModal.show { display: block; }
        .legend-item { display: flex; align-items: center; margin: 10px 0; font-size: 0.9rem; }
        .legend-emoji { font-size: 1.5rem; margin-right: 10px; width: 30px; text-align: center; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.2rem; cursor: pointer; color: #999; }

        .hidden { display: none !important; }

        /* Floating Text */
        .floating-text {
            position: absolute; font-weight: bold; font-size: 1.2rem;
            pointer-events: none; animation: floatUp 1.5s ease-out forwards;
            text-shadow: 0 0 3px white; z-index: 50;
        }
        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <canvas id="gameCanvas"></canvas>

    <div id="uiLayer">
        <div id="gameHud" class="hidden" style="display: flex; flex-direction: column; height: 100%;">
            <div class="top-bar">
                <div style="display: flex; align-items: center;">
                    <div class="day-badge">äº‹ä»¶ <span id="dayVal">1</span> / 10</div>
                    <div class="help-btn" onclick="game.toggleLegend()">?</div>
                    <div class="help-btn" onclick="game.goHome()">ğŸ </div>
                </div>
                <div class="money-display">ğŸ’° <span id="moneyVal">1000</span></div>
            </div>

            <div class="stats-container">
                <div class="stat-row" id="stat-Mood">
                    <div class="stat-label">ğŸ˜Š</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 50%; background: #f1c40f;"></div></div>
                    <div class="stat-val-text">50</div>
                </div>
                <div class="stat-row" id="stat-Hunger">
                    <div class="stat-label">ğŸ”</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 20%; background: #e74c3c;"></div></div>
                    <div class="stat-val-text">20</div>
                </div>
                <div class="stat-row" id="stat-Values">
                    <div class="stat-label">âš–ï¸</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 50%; background: #3498db;"></div></div>
                    <div class="stat-val-text">50</div>
                </div>
                <div class="stat-row" id="stat-Health">
                    <div class="stat-label">â¤ï¸</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 70%; background: #9b59b6;"></div></div>
                    <div class="stat-val-text">70</div>
                </div>
                <div class="stat-row" id="stat-SelfWorth">
                    <div class="stat-label">ğŸ’</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 50%; background: #e67e22;"></div></div>
                    <div class="stat-val-text">50</div>
                </div>
                 <div class="stat-row" id="stat-Social">
                    <div class="stat-label">ğŸ’¬</div>
                    <div class="progress-bar"><div class="progress-fill" style="width: 50%; background: #1abc9c;"></div></div>
                    <div class="stat-val-text">50</div>
                </div>
            </div>

            <div id="mainContent">
                <div class="event-card" id="eventCard">
                    <div class="event-emoji" id="eventEmoji">ğŸ¤”</div>
                    <div class="event-text" id="eventText">äº‹ä»¶è¼‰å…¥ä¸­...</div>
                    <div class="event-subtext" id="eventSubtext">...</div>
                </div>

                <div class="options-container" id="optionsContainer">
                    <!-- Options -->
                </div>
            </div>

            <div class="history-container" id="historyLog">
                <div style="color:#999; text-align:center; padding-top:30px;">(æ­·ç¨‹ç´€éŒ„å°‡é¡¯ç¤ºæ–¼æ­¤)</div>
            </div>
        </div>
    </div>

    <!-- Legend Modal -->
    <div id="legendModal">
        <div class="close-modal" onclick="game.toggleLegend()">âœ•</div>
        <h3 style="text-align:center; margin-top:0;">å±¬æ€§èªªæ˜</h3>
        <div class="legend-item"><div class="legend-emoji">ğŸ’°</div><div>é‡‘éŒ¢ï¼šä½ çš„è²¡ç”¢</div></div>
        <div class="legend-item"><div class="legend-emoji">ğŸ˜Š</div><div>æƒ…ç·’ï¼šå¿«æ¨‚ç¨‹åº¦</div></div>
        <div class="legend-item"><div class="legend-emoji">ğŸ”</div><div>é£¢é¤“ï¼šè‚šå­é¤“æ‹‰</div></div>
        <div class="legend-item"><div class="legend-emoji">â¤ï¸</div><div>å¥åº·ï¼šèº«å¿ƒç‹€æ…‹</div></div>
        <div class="legend-item"><div class="legend-emoji">âš–ï¸</div><div>åƒ¹å€¼è§€ï¼šç†æ™ºç¨‹åº¦</div></div>
        <div class="legend-item"><div class="legend-emoji">ğŸ’</div><div>è‡ªæˆ‘åƒ¹å€¼ï¼šæˆå°±æ„Ÿ</div></div>
        <div class="legend-item"><div class="legend-emoji">ğŸ’¬</div><div>ç¤¾äº¤ï¼šäººéš›é—œä¿‚</div></div>
    </div>

    <!-- Start Screen -->
    <div id="startScreen" class="screen active">
        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ’¸</div>
        <div class="title-main">éŒ¢éƒ½å»å“ªäº†ï¼Ÿ</div>
        <div class="subtitle"><br>æ³¨æ„ï¼šé‡‘éŒ¢ä¸€è®Šæˆè² æ•¸ï¼Œç«‹å³çµæŸéŠæˆ²ï¼</div>
        <button class="big-btn" onclick="game.start()">é–‹å§‹æŒ‘æˆ°</button>
        <button class="secondary-btn" onclick="game.toggleLegend()">æŸ¥çœ‹å±¬æ€§èªªæ˜</button>
    </div>

    <!-- Game Over Screen -->
    <div id="gameOverScreen" class="screen">
        <div id="endEmoji" style="font-size: 5rem; margin-bottom: 10px;">ğŸ’€</div>
        <div class="title-main" id="endTitle">ç ´ç”¢äº†</div>
        <div class="subtitle" id="endReason">ä½ çš„éŒ¢åŒ…å’Œä½ è…¦è¢‹ä¸€æ¨£ç©ºã€‚</div>
        
        <div class="end-stat-grid" id="endStats">
            <!-- Injected by JS -->
        </div>

        <button class="big-btn" onclick="game.start()">å†è©¦ä¸€æ¬¡</button>
    </div>
</div>

<script>
/* ================= GAME DATA ================= */
const EVENTS_POOL = [
    // ä¿®æ­£ 3: æ¨™è¨˜ Lottery äº‹ä»¶ï¼Œæ©Ÿç‡åœ¨ Logic ä¸­æ§åˆ¶
    {
        text: "ã€çªç™¼ã€‘ä¸­äº†ç™¼ç¥¨/æ¨‚é€",
        emoji: "ğŸŸï¸",
        type: 'lottery', 
        options: [
            // ä¿®æ­£ 3: é¸ä¸­é ­çè§¸ç™¼ flag
            { text: "ä¸­é ­çï¼ï¼ï¼", effects: { Money: 0 }, flag: 'jackpot_winner' }, 
            { text: "ä¸­å…©ç™¾å¡Š", effects: { Money: 200, Mood: 10 } },
            { text: "æ²’ä¸­ï¼Œæ§“é¾œ", effects: { Money: -50, Mood: -5 } }
        ]
    },
    // ä¿®æ­£ 4: æ–°å¢è³­åšäº‹ä»¶ (dynamic logic in handleChoice)
    {
        text: "åœ°ä¸‹è³­å ´è©¦æ‰‹æ°£ (1-10 çŒœå¤§å°)",
        emoji: "ğŸ²",
        type: 'gamble',
        options: [
            { text: "æŠ¼å¤§ (6-10)", gambleType: 'big' },
            { text: "æŠ¼å° (1-5)", gambleType: 'small' },
            { text: "ä¸è³­å¿«é€ƒ", gambleType: 'none', effects: { Mood: -5, Values: 5 } }
        ]
    },
    // --- Basic Events ---
    {
        text: "åˆé¤æ™‚é–“ï¼šä½ è‚šå­é¤“äº†",
        emoji: "ğŸ±",
        type: 'food',
        options: [
            { text: "å¤–é€è±ªè¯ä¾¿ç•¶", effects: { Money: -250, Mood: 35, SelfWorth: 5, Hunger: -70, Values: -15, Health: 5 } },
            { text: "è‡ªå¸¶ä¾¿ç•¶", effects: { Money: 0, Mood: 5, SelfWorth: 10, Hunger: -50, Values: 10, Health: 2 } },
            { text: "å¿ä¸€ä¸‹ä¸åƒ", effects: { Mood: -15, SelfWorth: -5, Hunger: 20, Values: 5, Health: -5 } }
        ]
    },
    {
        text: "çœ‹åˆ°è¶…åˆ’ç®—æ‰‹éŠç¦®åŒ…",
        emoji: "ğŸ“±",
        type: 'gaming',
        options: [
            { text: "è¶Šè²´è¶Šåˆ’", effects: { Money: -400, Mood: 40, SelfWorth: 10, Values: -25, Health: 0 } },
            { text: "åªè²·æœ€ä¾¿å®œçš„", effects: { Money: -50, Mood: 10, SelfWorth: 5, Values: -10, Health: 0 } },
            { text: "ç›´æ¥ç„¡è¦–", effects: { Mood: -5, SelfWorth: 5, Values: 10 } }
        ]
    },
    {
        text: "å…¬å¸ç™¼äº†ä¸€ç­†å°çé‡‘",
        emoji: "ğŸ’°",
        options: [
            { text: "å…¨éƒ¨å­˜èµ·ä¾†", effects: { Money: 200, Mood: 5, SelfWorth: 10, Values: 10, Health: 2 } },
            { text: "æ‹¿å»çŠ’è³è‡ªå·±", effects: { Money: 0, Mood: 30, SelfWorth: 5, Values: -10, Health: 5 } },
            { text: "å­˜ä¸€åŠèŠ±ä¸€åŠ", effects: { Money: 100, Mood: 10, SelfWorth: 7, Values: 5 } }
        ]
    },
    {
        text: "ä¸‹åˆå·¥ä½œå€¦æ€ ï¼Œçœ‹åˆ°é›¶é£Ÿæ«ƒ",
        emoji: "ğŸª",
        type: 'food',
        options: [
            { text: "åƒé›¶é£Ÿå›‰", effects: { Mood: 15, SelfWorth: -5, Hunger: -15, Values: -10, Health: -10 } },
            { text: "åƒè‡ªå‚™æ°´æœ", effects: { Mood: 6, SelfWorth: 6, Hunger: -10, Values: 8, Health: 5 } },
            { text: "å¿ä½ä¸åƒ", effects: { Mood: -8, Hunger: 10, SelfWorth: 5, Values: 5 } }
        ]
    },
    {
        text: "åŠå¤œè·¯éé¹¹é…¥é›æ”¤",
        emoji: "ğŸ—",
        type: 'food',
        options: [
            { text: "è€é—†ï¼ä¸€ä»½å°è¾£", effects: { Money: -100, Mood: 25, Hunger: -40, Health: -10, Values: -5 } },
            { text: "å°åƒä¸€é»ä¸¦åŠ å€‹è”¬èœ", effects: { Money: -80, Mood: 10, Hunger: -20, Health: -2, Values: 0 } },
            { text: "å¿«æ­¥èµ°é", effects: { Mood: -5, Hunger: 10, Health: 5, Values: 5 } }
        ]
    },
    {
        text: "é£¯åº—åƒåˆ°é£½è‡ªåŠ©é¤ç‰¹åƒ¹",
        emoji: "ğŸ¦",
        type: 'food',
        options: [
            { text: "åƒçˆ†ï¼æ‹¼å›æœ¬", effects: { Money: -800, Mood: 40, Hunger: -100, Health: -15, Values: -20 } },
            { text: "é–‹å¿ƒåƒ", effects: { Money: -800, Mood: 20, Hunger: -50, Health: 5, Values: -10 } }, 
            { text: "å¤ªè²´äº†ä¸åƒ", effects: { Money: 0, Mood: -10, Values: 15 } }
        ]
    },
    {
        text: "å†°ç®±è£¡çš„éæœŸç‰›å¥¶",
        emoji: "ğŸ¥›",
        type: 'food',
        options: [
            { text: "èèµ·ä¾†æ²’å£ï¼Œå–ï¼", effects: { Money: 0, Hunger: -10 }, risk: {chance: 0.7, fail: {Health: -30, Mood: -20}, success: {Mood: 5}} },
            { text: "å€’æ‰è²·æ–°çš„", effects: { Money: -90, Hunger: -10, Health: 5, Values: 5 } },
            { text: "å‡è£æ²’çœ‹åˆ°", effects: { Money: 0, Hunger: 5, Values: -5 } }
        ]
    },
    {
        text: "éŠæˆ²æ¨å‡ºé™å®šé€£å‹•è§’è‰²",
        emoji: "ğŸ®",
        type: 'gaming',
        options: [
            { text: "ä¿åº•æŠ½åˆ°æœ‰", effects: { Money: -2500, Mood: 60, SelfWorth: 20, Values: -50, Social: 10 } },
            { text: "è©¦æ°´æº«æŠ½åé€£", effects: { Money: -300, Mood: 5 }, risk: {chance: 0.1, success: {Mood: 50}, fail: {Mood: -10}} },
            { text: "æˆ‘æ˜¯å…è²»ä»”", effects: { Money: 0, Values: 10, Social: -5 } }
        ]
    },
    {
        text: "æ‰‹éŠé«˜ç´šé€šè¡Œè­‰",
        emoji: "ğŸ«",
        type: 'gaming',
        options: [
            { text: "è²·ï¼ç‚ºäº†çå‹µ", effects: { Money: -350, Mood: 15, Values: -5, Health: -5 } }, 
            { text: "ä¸è²·ï¼Œä½›ç³»ç©", effects: { Money: 0, Mood: 0, Values: 5 } },
            { text: "é€€å‘ä¿å¹³å®‰", effects: { Money: 0, Mood: -5, Health: 5, Social: -10 } }
        ]
    },
    {
        text: "å’Œæœ‹å‹ä¸€èµ·ç©éŠæˆ² ä½†æˆ°åŠ›è½å¾Œ",
        emoji: "âš”ï¸",
        type: 'gaming',
        options: [
            { text: "è²·ç¥è£å¸³è™Ÿ!", effects: { Money: -1500, Mood: 40, SelfWorth: 30, Values: -30 } },
            { text: "è²·é»éŠæˆ²å¹£", effects: { Money: -200, Mood: 10, Values: -5 } },
            { text: "æ…¢æ…¢ç·´æ€¥ç”šéº¼", effects: { Money: 0, SelfWorth: 15, Health: -10, Values: 10, Social: -10 } }
        ]
    },
    {
        text: "ã€çªç™¼ã€‘ç™¼ç”Ÿè»Šç¦æ„å¤–",
        emoji: "ğŸš‘",
        type: 'major',
        options: [
            { text: "æˆ‘æœ‰ä¿éšª (ç†è³ )", effects: { Money: 2000, Health: -40, Mood: -30 }, flag: 'injured' },
            { text: "ç§ä¸‹å’Œè§£è³ éŒ¢", effects: { Money: -5000, Health: -10, Mood: -20, Values: -10 } },
            { text: "é‡å‚·é€é†« (ç„¡ä¿éšª)", effects: { Money: -1000, Health: -80, Mood: -50 }, flag: 'disabled' }
        ]
    },
    {
        text: "ã€çªç™¼ã€‘å…¬å¸å®£å¸ƒå¤§è¦æ¨¡è£å“¡",
        emoji: "ğŸ“‰",
        type: 'major',
        options: [
            { text: "ä¸å¹¸è¢«è£ (é ˜è³‡é£è²»)", effects: { Money: 1500, SelfWorth: -60, Mood: -40, Social: -20 }, flag: 'unemployed' },
            { text: "å€–å­˜ä½†é™è–ª", effects: { Money: -200, SelfWorth: -10, Mood: -20, Health: -10 } }, 
            { text: "ä¸»å‹•è¾­è·å‰µæ¥­", effects: { Money: -3000, SelfWorth: 40, Mood: 20, Health: -20 }, risk: {chance: 0.2, success: {Money: 10000}, fail: {Money: -2000}} }
        ]
    },
    {
        text: "ã€çªç™¼ã€‘èº«é«”åŠ‡çƒˆç–¼ç—›",
        emoji: "ğŸ¥",
        type: 'major',
        options: [
            { text: "æ›æ€¥è¨ºè©³ç´°æª¢æŸ¥", effects: { Money: -800, Health: 20, Mood: -10 }, risk: {chance: 0.3, fail: {Health: -50, text:"ç™¼ç¾é‡ç—…"}} },
            { text: "åƒæ­¢ç—›è—¥å¿è€", effects: { Money: -50, Health: -30, Mood: -5 } },
            { text: "ç›¸ä¿¡åæ–¹ç™‚æ³•", effects: { Money: -2000, Health: -60, Values: -30 } }
        ]
    },
    {
        text: "ã€çªç™¼ã€‘è½‰å¸³å¾Œç™¼ç¾æ˜¯è©é¨™",
        emoji: "ğŸ˜ˆ",
        type: 'major',
        options: [
            { text: "è¢«é¨™å…‰ç©è“„", effects: { Money: -500, Mood: -80, Values: 20, SelfWorth: -50 }, flag: 'scammed' },
            { text: "è¢«é¨™å…‰ç©è“„", effects: { Money: -1000, Mood: -80, Values: 20, SelfWorth: -50 }, flag: 'scammed' },
            { text: "è¢«é¨™å…‰ç©è“„", effects: { Money: -800, Mood: -80, Values: 20, SelfWorth: -50 } , flag: 'scammed'}
        ]
    },
    {
        text: "æœ‹å‹ç´„å–å’–å•¡èŠæ˜¯é",
        emoji: "â˜•",
        options: [
            { text: "å»å’–å•¡å»³", effects: { Money: -180, Mood: 20, SelfWorth: 5, Values: -5, MentalHealth: 8, Social: 15 } },
            { text: "è¦–è¨ŠèŠèŠå°±å¥½", effects: { Mood: 8, SelfWorth: 5, Values: 5, MentalHealth: 4, Social: 8 } },
            { text: "æ‹’çµ•ç¤¾äº¤!", effects: { Mood: -5, SelfWorth: -3, Values: 2, MentalHealth: 2, Social: -8 } }
        ]
    },
    {
        text: "é€šå‹¤è·¯ä¸Šçœ‹åˆ°é™æ™‚æŠ˜æ‰£",
        emoji: "ğŸ›ï¸",
        options: [
            { text: "è¡é€²å»è²·", effects: { Money: -220, Mood: 30, SelfWorth: 2, Values: -20, MentalHealth: 6 } },
            { text: "è§€æœ›ä¸€ä¸‹", effects: { Mood: -2, SelfWorth: 3, Values: 5 } },
            { text: "å …å®šé›¢é–‹", effects: { Mood: -5, SelfWorth: 8, Values: 10 } }
        ]
    },
    {
        text: "æœ‹å‹åœ¨ IG ç‚«è€€æ–°åŒ…åŒ…",
        emoji: "ğŸ‘œ",
        options: [
            { text: "æœå°‹åŒæ¬¾æƒ³è²·", effects: { Money: -300, Mood: 20, SelfWorth: 8, Values: -20, MentalHealth: 3 } },
            { text: "ç•™è¨€ç¨±è®š", effects: { Mood: 5, SelfWorth: 3, Values: 5, Social: 4 } },
            { text: "é€™æœ‹å‹ä¸è¦äº†", effects: { Mood: -2, SelfWorth: 10, Values: 10, MentalHealth: 2, Social: -30 } }
        ]
    },
    {
        text: "ä¸‹ç­è·¯éè¶…å¸‚è›‹ç³•æ‰“æŠ˜",
        emoji: "ğŸ°",
        options: [
            { text: "è²·å›å®¶å¤§åƒ", effects: { Money: -120, Mood: 25, Hunger: -30, SelfWorth: 2, Values: -8 } },
            { text: "è²·æ‰“æŠ˜æ°´æœ", effects: { Money: -60, Mood: 8, Hunger: -20, Values: 5, SelfWorth: 5 } },
            { text: "ç¯€åˆ¶è·³é", effects: { Mood: -5, Hunger: 5, Values: 5 } }
        ]
    },
    {
        text: "å¿ƒæƒ…ä¸å¥½æƒ³ã€Œæ²»ç™‚ã€è‡ªå·±",
        emoji: "ğŸ¥º",
        options: [
            { text: "è³¼ç‰©ç™‚æ³•", effects: { Money: -500, Mood: 50, SelfWorth: 15, Values: -35, MentalHealth: 20 } },
            { text: "æ‰¾æœ‹å‹å“­è¨´", effects: { Mood: 15, SelfWorth: 5, MentalHealth: 10, Social: 10 } },
            { text: "å†¥æƒ³/ç¡è¦º", effects: { Mood: 5, SelfWorth: 8, Values: 5, MentalHealth: 15 } }
        ]
    },
    {
        text: "æ”¶åˆ°æŠ•è³‡è¨Šæ¯",
        emoji: "ğŸ“ˆ",
        options: [
            { text: "è·Ÿé¢¨æŠ•è³‡", effects: { Money: -300, Mood: -10, Values: -15, MentalHealth: -10 }, risk: {chance: 0.4, success: {Money: 900, Mood: 50}} }, // Special handling logic needed
            { text: "å ±åç†è²¡èª²", effects: { Money: -150, SelfWorth: 15, Values: 12, MentalHealth: 5 } },
            { text: "ç„¡è¦–è©é¨™", effects: { Values: 2 } }
        ]
    },
    {
        text: "å¥èº«æˆ¿å¼·åŠ›æ¨éŠ·",
        emoji: "ğŸ’ª",
        options: [
            { text: "ç°½äº†ï¼æˆ‘è¦è®Šå£¯", effects: { Money: -400, SelfWorth: 20, Mood: 10, Values: 10, Hunger: 10 } },
            { text: "åƒ…é«”é©—ä¸€æ¬¡", effects: { Money: -50, Mood: 5, Hunger: 5 } },
            { text: "æˆ‘èƒ–æˆ‘é©•å‚²", effects: { Money: 0, Mood: 5, SelfWorth: -5, Values: 0 } }
        ]
    },
    {
        text: "ä¸²æµå¹³å°è¨‚é–±æ¼²åƒ¹é€šçŸ¥",
        emoji: "ğŸ“º",
        options: [
            { text: "çºŒè¨‚ï¼", effects: { Money: -30, Mood: 5, Values: -2 } },
            { text: "æ”¹ç•¶å…è²»ä»”çœ‹å»£å‘Š", effects: { Money: 0, Mood: -10, Values: 5, MentalHealth: -5 } },
            { text: "æˆ’æ‰è¿½åŠ‡", effects: { Money: 0, Mood: -15, Values: 10, Social: -5, SelfWorth: 5 } }
        ]
    },
    {
        text: "æ·±å¤œè‚šå­é¤“ä½†ä¸‹é›¨",
        emoji: "ğŸŒ§ï¸",
        options: [
            { text: "å«å¤–é€", effects: { Money: -200, Mood: 20, Hunger: -50, Values: -10 } },
            { text: "åƒæ³¡éºµ", effects: { Money: -20, Mood: 10, Hunger: -40, MentalHealth: -2 } },
            { text: "å–æ°´ç¡è¦º", effects: { Money: 0, Mood: -10, Hunger: 10, Values: 10, SelfWorth: 5 } }
        ]
    },
    {
        text: "æœ‹å‹çµå©šç™¼ç´…è‰²ç‚¸å½ˆ",
        emoji: "ğŸ§§",
        options: [
            { text: "å¤§åŒ…ç´…åŒ…å……é¢å­", effects: { Money: -600, Mood: 10, SelfWorth: 20, Social: 20, Values: -10 } },
            { text: "ä¸€èˆ¬è¡Œæƒ…åƒ¹", effects: { Money: -300, Social: 5, Values: 5 } },
            { text: "è£å¿™ä¸å»", effects: { Money: 0, Social: -30, Mood: -5, SelfWorth: -5 } }
        ]
    },
    {
        text: "æœ€æ–°ä¸€ä»£æ‰‹æ©Ÿç™¼è¡¨",
        emoji: "ğŸ“±",
        options: [
            { text: "æ‰‹åˆ€é è³¼", effects: { Money: -800, Mood: 50, SelfWorth: 30, Values: -40 } },
            { text: "æ‰‹æ©Ÿé‚„èƒ½ç”¨", effects: { Money: 0, Values: 15, SelfWorth: 5 } },
            { text: "é…¸å®ƒæ²’æ–°æ„", effects: { Mood: 5, Social: -5 } }
        ]
    },
    {
        text: "çªç„¶ç”Ÿç—…ä¸èˆ’æœ",
        emoji: "ğŸ˜·",
        options: [
            { text: "è«‹å‡çœ‹é†«ç”Ÿ", effects: { Money: -150, Mood: -10, MentalHealth: 20, SelfWorth: -5 } },
            { text: "æˆè—¥åƒåƒå°±å¥½", effects: { Money: -50, Mood: -5, MentalHealth: 5 } },
            { text: "ç¡¬æ’å»ä¸Šç­", effects: { Money: 100, Mood: -30, MentalHealth: -20, SelfWorth: 10 } }
        ]
    },
    {
        text: "è·¯ä¸Šæœ‰äººåœ¨è³£æ„›å¿ƒç­†",
        emoji: "ğŸ–Šï¸",
        options: [
            { text: "è²·ä¸€æ”¯æ”¯æŒ", effects: { Money: -100, Mood: 10, SelfWorth: 10, Values: -5 } },
            { text: "å‡è£æ²’è½åˆ°", effects: { Money: 0, Mood: -2, Social: -2 } },
            { text: "ç½µä»–ï¼", effects: { Money: 0, Mood: -10, Values: -10, Social: -10 } }
        ]
    },
    {
        text: "è¨ˆç¨‹è»Šé‚„æ˜¯èµ°è·¯ï¼Ÿ",
        emoji: "ğŸš•",
        options: [
            { text: "æˆ‘çˆ›æˆ‘æ­è»Š", effects: { Money: -150, Mood: 10, Hunger: 0, MentalHealth: 5 } },
            { text: "èµ°è·¯ç•¶é‹å‹•", effects: { Money: 0, Mood: -5, Hunger: 10, MentalHealth: 5, Values: 5 } },
            { text: "é¨å…±äº«å–®è»Š", effects: { Money: -15, Mood: 0, Hunger: 5, Values: 5 } }
        ]
    },
    {
        text: "ç¶²è³¼æ¹Šå…é‹",
        emoji: "ğŸ“¦",
        options: [
            { text: "å¤šè²·ä¸€ä»¶è¡£æœ", effects: { Money: -300, Mood: 20, Values: -15 } },
            { text: "ä»˜é‹è²»å°±å¥½", effects: { Money: -60, Mood: -5, Values: 5 } },
            { text: "æ¸…ç©ºè³¼ç‰©è»Šä¸è²·äº†", effects: { Money: 0, Mood: -10, Values: 15, SelfWorth: 10 } }
        ]
    },
    {
        text: "å®¶è£¡é›»å™¨å£äº†",
        emoji: "ğŸ”Œ",
        options: [
            { text: "è²·æœ€æ–°çš„", effects: { Money: -500, Mood: 25, Values: -20 } },
            { text: "æ‰¾äººä¿®", effects: { Money: -200, Mood: 0, Values: 5 } },
            { text: "æ•²ä¸€æ•² å°‡å°±è‘—ç”¨", effects: { Money: 0, Mood: -20, MentalHealth: -10, Values: 10 } }
        ]
    },
    {
        text: "å¶åƒé–‹æ¼”å”±æœƒ",
        emoji: "ğŸ«",
        options: [
            { text: "æ¶æ–æ»¾å€!", effects: { Money: -500, Mood: 60, MentalHealth: 20, Values: -30 } },
            { text: "è²·çœ‹å°å€", effects: { Money: -200, Mood: 30, Values: -10 } },
            { text: "ä¸åƒåŠ ", effects: { Money: 0, Mood: -30, Social: -10 } }
        ]
    },
    {
        text: "è¾¦å…¬å®¤åœ˜è³¼é›¶é£Ÿ",
        emoji: "ğŸ©",
        options: [
            { text: "è·Ÿä¸€æ³¢", effects: { Money: -80, Mood: 15, Social: 10, Hunger: -10, Values: -5 } },
            { text: "ä¸è·Ÿ", effects: { Money: 0, Social: -15, Values: 5 } },
            { text: "å¹«å¿™ç™»è¨˜", effects: { Money: 0, Social: 20, Mood: 5 } }
        ]
    },
    {
        text: "è¢«çŸ­å½±ç‰‡ç”Ÿç«æŸå€‹åƒåœ¾å°ç‰©",
        emoji: "ğŸ”¥",
        options: [
            { text: "ä¸‹å–®ï¼", effects: { Money: -180, Mood: 25, SelfWorth: -5, Values: -25 } },
            { text: "æ”¾å…¥è¿½è¹¤æ¸…å–®", effects: { Money: 0, Mood: 0, Values: 0 } },
            { text: "ç™½ç™¡æ‰è²·", effects: { Money: 0, SelfWorth: 10, Values: 10 } }
        ]
    },
    {
        text: "æˆ¿æ±é€šçŸ¥è¦æ¼²ç§Ÿ/ç¹³å¸³å–®",
        emoji: "ğŸ§¾",
        options: [
            { text: "ä¹–ä¹–ç¹³éŒ¢", effects: { Money: -300, Mood: -20, Values: 5, SelfWorth: 5 } },
            { text: "æ‹–å»¶å¹¾å¤©", effects: { Money: 0, Mood: 5, Values: -10, MentalHealth: -15 } }, // Late fee logic implied?
            { text: "æ‰“é›»è©±å“­çª®", effects: { Money: -250, SelfWorth: -20, Social: -10 } }
        ]
    },
    {
        text: "æƒ³å­¸æ–°æŠ€èƒ½",
        emoji: "ğŸ“š",
        options: [
            { text: "è²·ç·šä¸Šå…¨å¥—èª²", effects: { Money: -350, SelfWorth: 20, Values: 10, Mood: 5 } },
            { text: "çœ‹å…è²» YouTube", effects: { Money: 0, SelfWorth: 10, Values: 15 } },
            { text: "å¤ªç´¯äº†ç®—äº†", effects: { Money: 0, SelfWorth: -10, Mood: 5 } }
        ]
    },
    {
        text: "åœ¨è·¯ä¸Šæ’¿åˆ° 100 å…ƒ",
        emoji: "ğŸ’µ",
        options: [
            { text: "æš—æ§“èµ·ä¾†", effects: { Money: 100, Mood: 20, Values: -20, SelfWorth: -5 } },
            { text: "æçµ¦ä¾¿åˆ©å•†åº—", effects: { Money: 0, Mood: 10, Values: 20, SelfWorth: 10 } },
            { text: "äº¤çµ¦è­¦å¯Ÿ", effects: { Money: 0, Mood: -5, Values: 25 } }
        ]
    },
    {
        text: "ç›²ç›’/æ‰­è›‹æ©Ÿ",
        emoji: "ğŸ’Š",
        options: [
            { text: "æŠ½åˆ°éš±è—ç‰ˆç‚ºæ­¢", effects: { Money: -300, Mood: 35, Values: -30, MentalHealth: -5 } },
            { text: "åªæŠ½ä¸€å€‹", effects: { Money: -60, Mood: 10, Values: -5 } },
            { text: "çœ‹çœ‹å°±å¥½", effects: { Money: 0, Values: 5 } }
        ]
    },
    {
        text: "çˆ¶æ¯æ‰“é›»è©±ä¾†å•å€™",
        emoji: "ğŸ“",
        options: [
            { text: "è½‰éŒ¢å­æ•¬", effects: { Money: -200, Mood: 10, Values: 20, Family: 20 } },
            { text: "èŠèŠå¤©", effects: { Money: 0, Mood: 15, MentalHealth: 10, Social: 10 } },
            { text: "èªªåœ¨å¿™æ›æ‰", effects: { Money: 0, Mood: -10, Values: -10, MentalHealth: -10 } }
        ]
    },
    {
        text: "åŠå¤œç¡ä¸è‘—",
        emoji: "ğŸ¦‰",
        options: [
            { text: "ç¶²è³¼é€›è¦çš®", effects: { Money: -150, Mood: 15, MentalHealth: -5 } },
            { text: "è¿½åŠ‡åˆ°å¤©äº®", effects: { Money: 0, Mood: 10, MentalHealth: -20, Hunger: 10 } },
            { text: "æ•¸ç¾Š", effects: { Money: 0, Mood: -5, MentalHealth: 10 } }
        ]
    },
    {
        text: "åˆ®åˆ®æ¨‚èª˜æƒ‘",
        emoji: "ğŸ«",
        options: [
            { text: "è²·ä¸€å¼µè©¦æ‰‹æ°£", effects: { Money: -100, Mood: 5 }, risk: {chance: 0.2, success: {Money: 200, Mood: 30}} },
            { text: "åŒ…æ•´æœ¬", effects: { Money: -500, Mood: 10, Values: -40 }, risk: {chance: 0.1, success: {Money: 2000, Mood: 100}} },
            { text: "ä¸è³­åš", effects: { Money: 0, Values: 10 } }
        ]
    },
    {
        text: "åˆé¤æ™‚é–“ï¼Œè¶…æƒ³åƒéº¥ç•¶å‹â€¦",
        emoji: "ğŸ”",
        type: "food",
        options: [
            { text: "å¤ªèƒ–ä¸åƒ", effects: { Mood: -10, SelfWorth: 5, Values: 10, Hunger: 10 } },
            { text: "å¥—é¤è–¯æ¢åŠ å¤§ï¼", effects: { Money: -200, Mood: 25, Hunger: -60, Health: -10, Values: -10 } },
            { text: "åªåƒè–¯æ¢!", effects: { Money: -60, Mood: 10, Hunger: -20, Health: -5 } }
    ]
    },
    {
        text: "ä»Šå¤©è©²æ€éº¼æ´—æ¾¡ï¼Ÿ",
        emoji: "ğŸ›",
        options: [
        { text: "æ³°åœ‹æµ´", effects: { Money: -800, Mood: 40, Health: 10, Values: -50, Social: -10 } },
        { text: "æ³¡æ³¡æµ´", effects: { Money: -800, Mood: 50, Health: 10, Values: -50, Social: -10 } },
        { text: "å›å®¶æ´—æ¾¡", effects: { Money: 0, Mood: 5, Health: 5, Values: 10 } }
        ]
    },
    {
        text: "åŒäº‹æªé£²æ–™ï¼Œä½ è¦è·Ÿå—ï¼Ÿ",
        emoji: "ğŸ§‹",
        options: [
            { text: "è¨‚ï¼å“ªæ¬¡ä¸è¨‚ï¼", effects: { Money: -80, Mood: 15, Social: 10, Values: -5 } },
            { text: "æˆ‘å–æ°´", effects: { Mood: -5, Values: 10, Health: 5 } },
            { text: "å«åŒäº‹è«‹å®¢", effects: { Money: 0, Mood: 10, Social: -15, Values: -10, SelfWorth: 5 } }
        ]
    }
];

/* ================= LOGIC ================= */
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

const GAME_CONFIG = {
    totalDays: 1,
    eventsPerDay: 10,
    initialStats: {
        Money: 1000,
        Mood: 50,
        SelfWorth: 50,
        Hunger: 20,
        Values: 50,
        Health: 70, 
        Social: 50
    }
};

let state = {
    day: 1,
    eventIndex: 0,
    stats: { ...GAME_CONFIG.initialStats },
    history: [],
    currentEvent: null,
    eventQueue: [],
    status: 'MENU',
    trackers: {
        foodSpend: 0,
        gamingSpend: 0,
        flags: [],
        lastEventType: null // ç”¨ä¾†åˆ¤æ–·æ˜¯å¦è³­åšç ´ç”¢
    }
};

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

class Game {
    constructor() {
        this.hud = document.getElementById('gameHud');
        this.startScreen = document.getElementById('startScreen');
        this.gameOverScreen = document.getElementById('gameOverScreen');
        this.historyLog = document.getElementById('historyLog');
        this.legendModal = document.getElementById('legendModal');
        
        this.uiIds = {
            day: document.getElementById('dayVal'),
            money: document.getElementById('moneyVal'),
            card: document.getElementById('eventCard'),
            emoji: document.getElementById('eventEmoji'),
            text: document.getElementById('eventText'),
            options: document.getElementById('optionsContainer'),
            bars: {
                Mood: document.querySelector('#stat-Mood .progress-fill'),
                Hunger: document.querySelector('#stat-Hunger .progress-fill'),
                Values: document.querySelector('#stat-Values .progress-fill'),
                Health: document.querySelector('#stat-Health .progress-fill'),
                SelfWorth: document.querySelector('#stat-SelfWorth .progress-fill'),
                Social: document.querySelector('#stat-Social .progress-fill')
            },
            vals: {
                Mood: document.querySelector('#stat-Mood .stat-val-text'),
                Hunger: document.querySelector('#stat-Hunger .stat-val-text'),
                Values: document.querySelector('#stat-Values .stat-val-text'),
                Health: document.querySelector('#stat-Health .stat-val-text'),
                SelfWorth: document.querySelector('#stat-SelfWorth .stat-val-text'),
                Social: document.querySelector('#stat-Social .stat-val-text')
            }
        };
    }

    start() {
        state.day = 1;
        state.eventIndex = 0;
        state.stats = { ...GAME_CONFIG.initialStats };
        state.status = 'PLAYING';
        state.history = [];
        state.trackers = { foodSpend: 0, gamingSpend: 0, flags: [], lastEventType: null };
        
        // ä¿®æ­£ 3: é™ä½å½©ç¥¨æ©Ÿç‡
        const lotteryEvent = EVENTS_POOL.find(e => e.type === 'lottery');
        const gambleEvent = EVENTS_POOL.find(e => e.type === 'gamble');
        const majorEvents = EVENTS_POOL.filter(e => e.type === 'major');
        const commonEvents = EVENTS_POOL.filter(e => e.type !== 'lottery' && e.type !== 'gamble' && e.type !== 'major');
        
        // å»ºç«‹æ± å­: åŸºæœ¬äº‹ä»¶
        let pool = [...commonEvents].sort(() => Math.random() - 0.5);
        
        // å¿…åŠ ä¸€å€‹ Major Event
        pool = pool.slice(0, GAME_CONFIG.eventsPerDay - 3); // ç•™ 3 å€‹ç©ºä½çµ¦ç‰¹æ®Šäº‹ä»¶
        pool.push(majorEvents[Math.floor(Math.random() * majorEvents.length)]);
        
        // 20% æ©Ÿç‡åŠ å…¥è³­åšäº‹ä»¶
        if (Math.random() < 0.2) pool.push(gambleEvent);
        else pool.push(commonEvents[Math.floor(Math.random() * commonEvents.length)]);
        
        // 5% æ©Ÿç‡åŠ å…¥å½©ç¥¨äº‹ä»¶ (Rare)
        if (Math.random() < 0.05) pool.push(lotteryEvent);
        else pool.push(commonEvents[Math.floor(Math.random() * commonEvents.length)]);

        // è£œæ»¿ 10 å€‹ (å¦‚æœä¸Šé¢æ²’åŠ æ»¿)
        while(pool.length < 10) {
             pool.push(commonEvents[Math.floor(Math.random() * commonEvents.length)]);
        }

        state.eventQueue = pool.sort(() => Math.random() - 0.5); // å†æ¬¡æ´—ç‰Œ

        this.startScreen.classList.remove('active');
        this.gameOverScreen.classList.remove('active');
        this.hud.classList.remove('hidden');
        this.historyLog.innerHTML = '<div style="color:#999; text-align:center; padding-top:10px;">(éŠæˆ²é–‹å§‹)</div>';
        
        this.updateUI();
        this.nextEvent();
        this.loop();
    }

    toggleLegend() {
        this.legendModal.classList.toggle('show');
    }

    nextEvent() {
        if (state.eventIndex >= GAME_CONFIG.eventsPerDay) {
            this.endDay();
            return;
        }

        state.currentEvent = state.eventQueue[state.eventIndex];
        this.renderEventCard(state.currentEvent);
    }

    renderEventCard(event) {
        const ui = this.uiIds;
        ui.emoji.textContent = event.emoji;
        ui.text.textContent = event.text;
        
        ui.card.style.opacity = '0';
        ui.card.style.transform = 'translateY(10px)';
        requestAnimationFrame(() => {
            ui.card.style.transition = 'all 0.4s ease';
            ui.card.style.opacity = '1';
            ui.card.style.transform = 'translateY(0)';
        });

        ui.options.innerHTML = '';
        event.options.forEach((opt) => {
            const btn = document.createElement('div');
            btn.className = 'option-btn';
            
            let hintHTML = '';
            if (opt.effects && opt.effects.Money && opt.effects.Money > 0) {
                hintHTML += `<span class="option-gain">+$${opt.effects.Money}</span>`;
            }

            btn.innerHTML = `<span>${opt.text}</span> ${hintHTML}`;
            
            btn.addEventListener('touchstart', (e) => { e.preventDefault(); this.handleChoice(opt); });
            btn.addEventListener('click', () => this.handleChoice(opt));
            
            ui.options.appendChild(btn);
        });

        document.getElementById('eventSubtext').textContent = `äº‹ä»¶ ${state.eventIndex + 1} / ${GAME_CONFIG.eventsPerDay}`;
        this.uiIds.day.textContent = state.eventIndex + 1;
    }

    handleChoice(option) {
        if (state.status !== 'PLAYING') return;

        state.trackers.lastEventType = state.currentEvent.type;
        let effects = option.effects ? { ...option.effects } : {};
        let actualChanges = {};
        let logText = option.text;

        // ä¿®æ­£ 4: è³­åšé‚è¼¯è™•ç†
        if (state.currentEvent.type === 'gamble' && option.gambleType !== 'none') {
            const roll = Math.floor(Math.random() * 10) + 1; // 1~10
            const isBig = roll >= 6;
            const win = (option.gambleType === 'big' && isBig) || (option.gambleType === 'small' && !isBig);
            
            if (win) {
                effects = { Money: 500, Mood: 20 };
                this.spawnFloatingText(`éª°å‡º ${roll}, è´äº†!`, window.innerWidth/2, window.innerHeight/2, '#27ae60');
                logText += ` (éª°å‡º${roll} è´)`;
            } else {
                effects = { Money: -500, Mood: -30 };
                this.spawnFloatingText(`éª°å‡º ${roll}, è¼¸äº†!`, window.innerWidth/2, window.innerHeight/2, '#e74c3c');
                logText += ` (éª°å‡º${roll} è¼¸)`;
            }
        }

        // Risk Calculation (Normal events)
        else if (option.risk) {
            if (Math.random() > option.risk.chance) { // Fail
                if (option.risk.fail) effects = { ...effects, ...option.risk.fail };
                this.spawnFloatingText("å¤±æ•—...", window.innerWidth/2, window.innerHeight/2, '#e74c3c');
            } else { // Success
                if (option.risk.success) effects = { ...effects, ...option.risk.success };
                this.spawnFloatingText("æˆåŠŸ!", window.innerWidth/2, window.innerHeight/2, '#27ae60');
            }
        }

        // Flag Tracking
        if (option.flag) state.trackers.flags.push(option.flag);

        // Spending Tracking
        if (state.currentEvent.type === 'food' && effects.Money < 0) state.trackers.foodSpend += Math.abs(effects.Money);
        if (state.currentEvent.type === 'gaming' && effects.Money < 0) state.trackers.gamingSpend += Math.abs(effects.Money);

        // Apply Stats
        for (let key in effects) {
            if (state.stats.hasOwnProperty(key)) {
                let oldVal = state.stats[key];
                state.stats[key] += effects[key];
                
                if (key !== 'Money') {
                    state.stats[key] = Math.max(0, Math.min(100, state.stats[key]));
                }
                
                actualChanges[key] = state.stats[key] - oldVal;
            }
        }

        this.logHistory(logText, actualChanges);
        this.showFeedback(actualChanges);
        this.updateUI();

        // ä¿®æ­£ 3: å½©ç¥¨é ­çéš±è—çµå±€
        if (option.flag === 'jackpot_winner') {
             this.triggerGameOver('é‚„æ•¢ä¸­é ­çé˜¿ é¤Šæˆ‘!', 'ä½ é‹æ°£å¥½åˆ°ä¸åƒæ˜¯é€™å€‹ä¸–ç•Œçš„äººã€‚å¿«åˆ†æˆ‘ä¸€é»ï¼', 'ğŸ¤‘');
             return;
        }

        // ä¿®æ­£ 2 & 4: é‡‘éŒ¢è² æ•¸ç«‹å³çµæŸ
        if (state.stats.Money < 0) {
            if (state.trackers.lastEventType === 'gamble') {
                this.triggerGameOver('è³­åˆ°ç ´ç”¢', 'åè³­ä¹è¼¸ï¼Œä½ ä¸ä¿¡é‚ªï¼Œçµæœè¼¸åˆ°è„«è¤²ã€‚', 'ğŸ²');
            } else {
                this.triggerGameOver('æ´»è©²çª®æ­»', 'æ²’éŒ¢é‚„æ•¢èŠ±ï¼Ÿä½ çš„ä¿¡ç”¨èˆ‡äººç”ŸåŒæ™‚ç ´ç”¢äº†ã€‚', 'ğŸ’¸');
            }
            return;
        }

        if (state.stats.Health <= 0) {
            this.triggerGameOver('ä¸å¹¸èº«äº¡', 'ä½ çš„å¥åº·ç‹€æ³æƒ¡åŒ–åˆ°äº†ç„¡æ³•æŒ½å›çš„åœ°æ­¥ã€‚', 'âš°ï¸');
            return;
        }
        if (state.stats.Hunger >= 100) {
            this.triggerGameOver('é¤“æ­»è¡—é ­', 'ä½ å¯¦åœ¨å¤ªé¤“äº†ï¼Œå·²ç¶“æ²’æœ‰åŠ›æ°£ç¹¼çºŒèµ°ä¸‹å»ã€‚', 'ğŸ–');
            return;
        }

        state.eventIndex++;
        setTimeout(() => this.nextEvent(), 300);
    }

    logHistory(choiceText, changes) {
        const item = document.createElement('div');
        item.className = 'history-item';
        
        let changeStr = [];
        const emojiMap = { Money: 'ğŸ’°', Mood: 'ğŸ˜Š', Hunger: 'ğŸ”', Health: 'â¤ï¸', Values: 'âš–ï¸', SelfWorth: 'ğŸ’', Social: 'ğŸ’¬' };
        
        for (let k in changes) {
            if (changes[k] === 0) continue;
            const val = changes[k] > 0 ? `+${changes[k]}` : changes[k];
            const cls = changes[k] > 0 ? 'diff-pos' : 'diff-neg';
            const isBad = (k === 'Hunger' && changes[k] > 0) || (k !== 'Hunger' && changes[k] < 0);
            const finalCls = isBad ? 'diff-neg' : 'diff-pos';
            
            changeStr.push(`${emojiMap[k]}<span class="${finalCls}">${val}</span>`);
        }

        item.innerHTML = `<span>é¸æ“‡: ${choiceText}</span><br><small>${changeStr.join(', ') || 'ç„¡è®ŠåŒ–'}</small>`;
        this.historyLog.prepend(item);
    }

    endDay() {
        if (state.stats.Hunger >= 80) state.stats.Health -= 10;
        this.determineEnding();
    }

    showFeedback(changes) {
        const cx = window.innerWidth / 2;
        const cy = window.innerHeight / 2;
        let delay = 0;
        for (let k in changes) {
            if (changes[k] === 0) continue;
            let color = changes[k] > 0 ? '#27ae60' : '#e74c3c';
            if (k === 'Hunger') color = changes[k] > 0 ? '#e74c3c' : '#27ae60';
            
            const txt = `${k} ${changes[k] > 0 ? '+' : ''}${changes[k]}`;
            setTimeout(() => {
                this.spawnFloatingText(txt, cx + (Math.random()*80 - 40), cy + (Math.random()*80 - 40), color);
            }, delay);
            delay += 100;
        }
    }

    spawnFloatingText(text, x, y, color) {
        const el = document.createElement('div');
        el.className = 'floating-text';
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        el.style.color = color;
        el.innerText = text;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 1500);
    }

    updateUI() {
        this.uiIds.money.innerText = state.stats.Money;
        
        for (let key in this.uiIds.bars) {
            const val = state.stats[key];
            this.uiIds.bars[key].style.width = val + '%';
            this.uiIds.vals[key].innerText = val;
            
            if (key === 'Hunger') {
                 this.uiIds.bars[key].style.background = val > 60 ? '#e74c3c' : '#2ecc71';
            } else if (key === 'Health' || key === 'Mood') {
                 this.uiIds.bars[key].style.background = val < 30 ? '#e74c3c' : (val > 70 ? '#2ecc71' : '#f1c40f');
            }
        }
    }

    determineEnding() {
        const s = state.stats;
        const t = state.trackers;
        let title = "æ™®é€šå¸‚æ°‘";
        let desc = "ä½ å¹³å¹³æ·¡æ·¡åœ°éå®Œäº†é€™ä¸€å¤©ã€‚ç„¡èŠï¼Œä½†å®‰å…¨ã€‚";
        let emoji = "ğŸ˜";

        if (s.Money < 300 && (s.Health < 40 || s.Mood < 40)) {
            title = "ä¸€èˆ¬çª®é¬¼";
            desc = "æ²’éŒ¢ã€æ²’å¿ƒæƒ…ã€æ²’å¥åº·ã€‚ä½ çœŸçš„éå¾—â€¦â€¦ç®—äº†ï¼Œä¸èªªå‚·äººã€‚";
            emoji = "ğŸª«";
        }else if (t.flags.includes('scammed') && s.Money < 0) {
            title = "ç™½ç™¡";
            desc = "ä½ ä¸æ˜¯è¼¸çµ¦ä¸–ç•Œï¼Œä½ æ˜¯è¼¸çµ¦è‡ªå·±çš„æ™ºå•†ã€‚è©é¨™é›†åœ˜éƒ½è¬è¬ä½ ã€‚";
            emoji = "ğŸ¤¡";
        }else if (t.flags.includes('disabled') || (t.flags.includes('injured') && s.Health < 30)) {
            title = "æ®˜éšœäººå£«";
            desc = "ä¸€å ´æ„å¤–æ°¸é æ”¹è®Šäº†ä½ çš„äººç”Ÿã€‚éŒ¢å†å¤šä¹Ÿè²·ä¸å›å¥åº·çš„èº«é«”ã€‚";
            emoji = "ğŸ¦½";
        } else if (t.flags.includes('lucky') || (s.Money > 10000)) {
            title = "å¹¸é‹æ˜Ÿ";
            desc = "å¤©é¸ä¹‹äººï¼ä¸ç®¡æ˜¯ä¸­æ¨‚é€é‚„æ˜¯å‰µæ¥­æˆåŠŸï¼Œä½ ç¾åœ¨è²¡å¯Œè‡ªç”±äº†ã€‚";
            emoji = "ğŸŒŸ";
        } else if (s.Money < 0 && s.Health < 30) {
            title = "å¯æ†äºº";
            desc = "æ²’éŒ¢ã€æ²’å¥åº·ï¼Œé€£è€å¤©çˆºéƒ½ä¸åŒæƒ…ä½ ã€‚æœ€æ‚²æ…˜çš„çµå±€ã€‚";
            emoji = "ğŸŒ§ï¸";
        } else if (s.Social <= 20) {
            title = "é‚Šç·£äºº";
            desc = "æœ‹å‹ä¸è¨˜å¾—ä½ ï¼ŒåŒäº‹ä¸æ‰¾ä½ ï¼Œä¸–ç•Œè·Ÿä½ æ²’æœ‰é—œä¿‚ã€‚";
            emoji = "ğŸ§";
        } else if (s.Hunger <= 15 && t.foodSpend > 500) {
            title = "è‚¥è±¬";
            desc = "ä½ é€™ä¸€å¤©é™¤äº†åƒé‚„æ˜¯åƒã€‚è‚šå­å¾ˆé£½ï¼Œå°±æ˜¯éš»è±¬ã€‚";
            emoji = "ğŸ·";
        } else if (t.gamingSpend > 2000) {
            title = "ç›¤å­";
            desc = "éŠæˆ²å…¬å¸æ„Ÿè¬æ‚¨çš„ä¹¾çˆ¹è´ŠåŠ©ã€‚ä½ ç²å¾—äº†è™›æ“¬çš„å¿«æ¨‚ï¼Œå’ŒçœŸå¯¦çš„è²§çª®ã€‚";
            emoji = "ğŸ’¸";
        } else if (t.gamingSpend >= 500) {
            title = "å°èª²ç©å®¶";
            desc = "é©åº¦èª²é‡‘è®“ç”Ÿæ´»æ›´å¿«æ¨‚ã€‚ä½ å¾ˆäº«å—ï¼Œä½†ä¹Ÿé‚„ç®—ç†æ™ºã€‚";
            emoji = "ğŸ®";
        }   else if (t.flags.includes('scammed') && s.Money < 0) {
            title = "ç™½ç™¡";
            desc = "ä½ ä¸æ˜¯è¼¸çµ¦ä¸–ç•Œï¼Œä½ æ˜¯è¼¸çµ¦è‡ªå·±çš„æ™ºå•†ã€‚è©é¨™é›†åœ˜éƒ½è¬è¬ä½ ã€‚";
            emoji = "ğŸ¤¡";
        } else if (s.Money <= 0) {
            title = "ç ´ç”¢è² å‚µ";
            desc = "ä½ çš„æˆ¶é ­åªå‰©ä¸‹å…©ä½æ•¸ã€‚æ˜å¤©è©²æ€éº¼è¾¦ï¼Ÿ";
            emoji = "ğŸ“‰";
        } else if (s.Money >= 1500 && s.Values >= 70) {
            title = "å®ˆè²¡å¥´";
            desc = "ä½ å­˜äº†å¾ˆå¤šéŒ¢ï¼Œä½†é€™ä¸€å¤©ä½ çœŸçš„å¿«æ¨‚å—ï¼Ÿ";
            emoji = "ğŸ”’";
        } else if (s.Mood >= 90 && s.Social >= 70) {
            title = "ç¤¾äº¤åæµ";
            desc = "äººè¦‹äººæ„›ï¼ŒèŠ±è¦‹èŠ±é–‹ã€‚ä½ çš„ç”Ÿæ´»å……æ»¿äº†å…‰é®®äº®éº—ã€‚";
            emoji = "âœ¨";
        }

        this.triggerGameOver(title, desc, emoji);
    }

    triggerGameOver(title, desc, emoji) {
        state.status = 'GAMEOVER';
        this.hud.classList.add('hidden');
        this.gameOverScreen.classList.add('active');
        
        document.getElementById('endTitle').innerText = title;
        document.getElementById('endReason').innerText = desc;
        document.getElementById('endEmoji').innerText = emoji;

        const grid = document.getElementById('endStats');
        grid.innerHTML = '';
        const emojiMap = { Money: 'ğŸ’°', Mood: 'ğŸ˜Š', Hunger: 'ğŸ”', Health: 'â¤ï¸', Values: 'âš–ï¸', SelfWorth: 'ğŸ’', Social: 'ğŸ’¬' };
        
        const keys = ['Money', 'Health', 'Mood', 'Hunger', 'Values', 'SelfWorth', 'Social'];
        
        keys.forEach(k => {
            let val = state.stats[k];
            let color = '#333';
            if (k === 'Money' && val < 0) color = '#e74c3c';
            grid.innerHTML += `<div class="end-stat-item">
                <span>${emojiMap[k]} ${k}</span>
                <span style="color:${color}; font-weight:bold;">${val}</span>
            </div>`;
        });
    }

    loop() {
        if (state.status === 'MENU') {
             this.drawBackground();
             requestAnimationFrame(() => this.loop());
             return;
        }
        if (state.status === 'GAMEOVER') {
            this.drawBackground(); 
            requestAnimationFrame(() => this.loop());
            return;
        }

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        this.drawBackground();
        requestAnimationFrame(() => this.loop());
    }

    drawBackground() {
        const time = Date.now() * 0.0002;
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, '#f2f0e4');
        gradient.addColorStop(1, '#e8e6d9');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = 'rgba(0,0,0,0.03)';
        ctx.font = '20px Arial';
        for(let i=0; i<8; i++) {
            const x = (Math.sin(time + i) * canvas.width/2) + canvas.width/2;
            const y = (Math.cos(time * 0.7 + i*2) * canvas.height/2) + canvas.height/2;
            ctx.fillText(i%2==0 ? "$" : "?", x, y);
        }
    }

    goHome() {
        // å›ä¸»é ï¼Œæ¸…ç©ºéŠæˆ² UIã€é¡¯ç¤ºä¸»ç•«é¢
        this.hud.classList.add('hidden');
        this.gameOverScreen.classList.remove('active');
        this.startScreen.classList.add('active');
        state.status = 'MENU';
    }
}

const game = new Game();
document.body.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

</script>
</body>
</html>
